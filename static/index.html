<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>Liquibase Control</title>
  <link rel="stylesheet" href="./bootstrap/bootstrap.min.css">
</head>

<body class="bg-light p-4">

  <div class="container">
    <h1 class="mb-2">Liquibase Command</h1>

    <!-- コマンド選択領域 -->
    <div class="row align-items-center mb-3">
      <label for="commandSelect" class="col-auto col-form-label fw-semibold">Command:</label>
      <div class="col-auto">
        <select id="commandSelect" class="form-select">
          <option value="history">History</option>
          <option value="status">Status</option>
          <option value="update">Update</option>
          <option value="rollback">Rollback</option>
          <option value="clear-checksums">Clear Checksums</option>
          <option value="changelog-sync">Changelog Sync</option>
        </select>
      </div>

      <div class="col-auto d-flex align-items-center gap-2" id="changelogGroup">
        <input type="text" id="changelogFile" class="form-control" placeholder="Changelog選択" style="width: 300px;">
        <button id="browseBtn" class="btn btn-primary">選択</button>
      </div>

      <div class="col-auto d-flex align-items-center gap-2 d-none" id="rollbackGroup">
        <label for="rollbackCount" class="fw-semibold mb-0">RollbackCount:</label>
        <input type="number" id="rollbackCount" class="form-control" value="1" min="1" max="999" style="width: 70px;">
      </div>
    </div>



    <!-- DB情報領域 -->
    <!-- Database URL -->
    <div class="mb-3">
      <div class="mb-2 row align-items-center">
        <label for="dbUrl" class="col-sm-2 col-form-label fw-semibold">Database URL:</label>
        <div class="col-sm-10">
          <input type="text" id="dbUrl" class="form-control">
        </div>
      </div>
      <!-- Database Name & Schema Name -->
      <div class="mb-2 row align-items-center">
        <!-- Database Name -->
        <label for="dbName" class="col-sm-2 col-form-label fw-semibold">Database Name:</label>
        <div class="col-sm-5">
          <input type="text" id="dbName" class="form-control">
        </div>
        <!-- Schema Name -->
        <label for="dbSchema" class="col-sm-1 col-form-label fw-semibold text-end">Schema:</label>
        <div class="col-sm-4">
          <input type="text" id="dbSchema" class="form-control">
        </div>
      </div>
      <!-- User Name -->
      <div class="mb-2 row align-items-center">
        <label for="dbUser" class="col-sm-2 col-form-label fw-semibold">User Name:</label>
        <div class="col-sm-10">
          <input type="text" id="dbUser" class="form-control">
        </div>
      </div>
      <!-- Password -->
      <div class="mb-2 row align-items-center">
        <label for="dbPassword" class="col-sm-2 col-form-label fw-semibold">Password:</label>
        <div class="col-sm-10">
          <input type="password" id="dbPassword" class="form-control">
        </div>
      </div>
    </div>

    <!-- ボタン領域 -->
    <div class="mb-3">
      <button id="runBtn" class="btn btn-primary me-2">コマンド実行</button>
      <button id="saveBtn" class="btn btn-secondary">設定保存</button>
    </div>

    <!-- 出力領域 -->
    <pre id="output" class="border rounded p-3"
      style="height: 430px; overflow-y: auto; background-color: #f5f5f5; font-size: 0.7rem;"></pre>

  </div>

  <script src="./bootstrap/bootstrap.bundle.min.js"></script>
  <script>
    const commandSelect = document.getElementById('commandSelect');
    const changelogGroup = document.getElementById('changelogGroup');
    const rollbackGroup = document.getElementById('rollbackGroup');
    const changelogFileInput = document.getElementById('changelogFile');
    const browseBtn = document.getElementById('browseBtn');
    const runBtn = document.getElementById('runBtn');
    const saveBtn = document.getElementById('saveBtn');
    const output = document.getElementById('output');
    const rollbackCount = document.getElementById('rollbackCount');
    const dbUrl = document.getElementById('dbUrl');
    const dbName = document.getElementById('dbName');
    const dbSchema = document.getElementById('dbSchema');
    const dbUser = document.getElementById('dbUser');
    const dbPassword = document.getElementById('dbPassword');

    async function initializeDefaults() {
      try {
        const settings = await window.liquibaseAPI.loadSettings();
        if (!settings) return;
        if (typeof settings.database_url === 'string') dbUrl.value = settings.database_url;
        if (typeof settings.database_name === 'string') dbName.value = settings.database_name;
        if (typeof settings.schema === 'string') dbSchema.value = settings.schema;
        if (typeof settings.user_name === 'string') dbUser.value = settings.user_name;
        dbPassword.value = '';
      } catch (error) {
        console.error('設定読み込みに失敗しました', error);
      }
    }

    initializeDefaults();

    // コマンド選択によるUI変更
    commandSelect.addEventListener('change', () => {
      const cmd = commandSelect.value;

      if (cmd === 'history' || cmd === 'clear-checksums') {
        changelogGroup.classList.add('d-none');
      } else {
        changelogGroup.classList.remove('d-none');
      }

      if (cmd === 'rollback') {
        rollbackGroup.classList.remove('d-none');
      } else {
        rollbackGroup.classList.add('d-none');
      }
    });
    commandSelect.dispatchEvent(new Event('change'));

    // ボタンイベント
    browseBtn.addEventListener('click', async () => {
      const result = await window.liquibaseAPI.openFile();
      if (!result.canceled && result.filePaths.length > 0) {
        changelogFileInput.value = result.filePaths[0];
      }
    });

    // コマンド実行時の出力処理
    runBtn.addEventListener('click', async () => {
      const cmd = commandSelect.value;
      const count = parseInt(rollbackCount.value || '1', 10);
      const url = dbUrl.value + dbName.value;
      output.textContent = `${cmd} 実行中...`;

      try {
        const options = { command: cmd, dbUrl: url, dbUser: dbUser.value, dbPassword: dbPassword.value, dbSchema: dbSchema.value };
        if (cmd !== 'history' && cmd !== 'clear-checksums') options.changelogFile = changelogFileInput.value;
        if (cmd === 'rollback') options.rollbackCount = count;

        const result = await window.liquibaseAPI.runCommand(options);
        output.textContent = result;
      } catch (err) {
        output.textContent = '⚠️ エラー発生:\n' + err.message;
      }
    });

    // 設定保存ボタンのイベント
    saveBtn.addEventListener('click', async () => {
      const data = {
        database_url: dbUrl.value,
        database_name: dbName.value,
        schema: dbSchema.value,
        user_name: dbUser.value
      };
      await window.liquibaseAPI.saveSettings(data);
      alert('設定が保存されました。');
    });
  </script>
</body>

</html>
