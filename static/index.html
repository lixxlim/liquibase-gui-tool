<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>Liquibase Control</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    label {
      font-weight: bold;
    }

/* 공통 버튼 스타일 */
button {
  background-color: #3b82f6; /* 은은한 블루 */
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease-in-out;
}

/* 호버 시 살짝 밝아지게 */
button:hover {
  background-color: #60a5fa;
}

/* 클릭 시 살짝 눌린 느낌 */
button:active {
  background-color: #2563eb;
  transform: translateY(1px);
}

/* 실행 버튼 강조 */
#runBtn {
  background-color: #2563eb;
}

#runBtn:hover {
  background-color: #1d4ed8;
}

#runBtn:active {
  background-color: #1e40af;
}

    #dbUrl {
      width: 600px;
    }

    #rollbackCount {
      width: 60px;
    }

    .form-row {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .command-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #output {
      background-color: #f0f0f0;
      padding: 10px;
      border: 1px solid #ccc;
      height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .flex-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>

<body>
  <h1>Liquibase Command</h1>

  <div class="form-row command-row">
    <label for="commandSelect">명령 선택:</label>
    <select id="commandSelect">
      <option value="history">History</option>
      <option value="status">Status</option>
      <option value="update">Update</option>
      <option value="rollback">Rollback</option>
    </select>

    <!-- Rollback 숫자 선택 영역 -->
    <div id="rollbackGroup" class="flex-right" style="display:none;">
      <label for="rollbackCount">Rollback 개수:</label>
      <input type="number" id="rollbackCount" value="1" min="1" max="999" />
    </div>

    <!-- 파일 선택 영역 -->
    <div id="changelogGroup" class="flex-right">
      <input type="text" id="changelogFile" />
      <button id="browseBtn">파일 선택</button>
    </div>
  </div>

  <div class="form-row">
    <label for="dbUrl">Database URL:</label>
    <input type="text" id="dbUrl" value="jdbc:postgresql://localhost:5432/" />
  </div>

  <div class="form-row">
    <label for="dbName">Database Name:</label>
    <input type="text" id="dbName" value="postgres" />
  </div>

  <div class="form-row">
    <label for="dbUser">User Name:</label>
    <input type="text" id="dbUser" value="postgres" />
  </div>

  <div class="form-row">
    <label for="dbPassword">Password:</label>
    <input type="password" id="dbPassword" value="postgres" />
  </div>

  <button id="runBtn">실행</button>
  <button id="saveBtn">설정 저장</button>

  <pre id="output"></pre>

  <script>
    const commandSelect = document.getElementById('commandSelect');
    const changelogGroup = document.getElementById('changelogGroup');
    const rollbackGroup = document.getElementById('rollbackGroup');
    const changelogFileInput = document.getElementById('changelogFile');
    const browseBtn = document.getElementById('browseBtn');
    const runBtn = document.getElementById('runBtn');
    const output = document.getElementById('output');
    const rollbackCount = document.getElementById('rollbackCount');
    const dbUrl = document.getElementById('dbUrl');
    const dbName = document.getElementById('dbName');
    const dbUser = document.getElementById('dbUser');
    const dbPassword = document.getElementById('dbPassword');

    // 명령 선택 시 UI 업데이트
    commandSelect.addEventListener('change', () => {
      const cmd = commandSelect.value;
      if (cmd === 'history') {
        changelogGroup.style.display = 'none';
        rollbackGroup.style.display = 'none';
      } else if (cmd === 'rollback') {
        changelogGroup.style.display = 'flex';
        rollbackGroup.style.display = 'flex';
      } else {
        changelogGroup.style.display = 'flex';
        rollbackGroup.style.display = 'none';
      }
    });

    // 초기 상태 반영
    commandSelect.dispatchEvent(new Event('change'));

    // 파일 선택
    browseBtn.addEventListener('click', async () => {
      const result = await window.liquibaseAPI.openFile();
      if (!result.canceled && result.filePaths.length > 0) {
        changelogFileInput.value = result.filePaths[0];
      }
    });

    // Liquibase 실행
    runBtn.addEventListener('click', async () => {
      const cmd = commandSelect.value;
      const count = parseInt(rollbackCount.value || '1', 10);
      const url = dbUrl.value + dbName.value;

      output.textContent = `${cmd} 실행 중...`;

      try {
        const options = {
          command: cmd,
          dbUrl: url,
          dbUser: dbUser.value,
          dbPassword: dbPassword.value
        };
        if (cmd !== 'history') options.changelogFile = changelogFileInput.value;
        if (cmd === 'rollback') options.rollbackCount = count;

        const result = await window.liquibaseAPI.runCommand(options);
        output.textContent = result;
      } catch (err) {
        output.textContent = '⚠️ 오류 발생:\n' + err.message;
      }
    });

    const saveBtn = document.getElementById('saveBtn');

    // 앱 실행 시 저장된 값 불러오기
    (async () => {
      const saved = await window.liquibaseAPI.loadSettings();
      if (saved.command) commandSelect.value = saved.command;
      if (saved.changelogFile) changelogFileInput.value = saved.changelogFile;
      if (saved.rollbackCount) rollbackCount.value = saved.rollbackCount;
      if (saved.dbUrl) dbUrl.value = saved.dbUrl;
      if (saved.dbName) dbName.value = saved.dbName;
      if (saved.dbUser) dbUser.value = saved.dbUser;
      if (saved.dbPassword) dbPassword.value = saved.dbPassword;

      commandSelect.dispatchEvent(new Event('change')); // UI 초기화
    })();

    // 저장 버튼 클릭
    saveBtn.addEventListener('click', async () => {
      const data = {
        command: commandSelect.value,
        changelogFile: changelogFileInput.value,
        rollbackCount: rollbackCount.value,
        dbUrl: dbUrl.value,
        dbName: dbName.value,
        dbUser: dbUser.value,
        dbPassword: dbPassword.value
      };
      await window.liquibaseAPI.saveSettings(data);
      alert('설정이 저장되었습니다.');
    });

  </script>
</body>

</html>